# Deploying to Maven Central
## Table of contents
1. [Introduction](#introduction)
2. [Prerequisites](#Prerequisites)
3. [GitHub Configuration](#GitHubConfiguration)
    1. [GitHub Actions Secrets](#GitHubActionSecrets)
        1. [List of Secrets](#GitHubActionSecretsList)
        2. [Purpose of Each Secret](#GitHubActionSecretsPurpose)
    2. [GitHub Actions Workflow](#GitHubActionsWorkflow)
        1. [Workflow Description](#GitHubActionsWorkflowDescription)
3. [Maven Pom File Configuration](#MavenConfig)
    1. [Required Plugins](#MavenReqPlugins)
    1. [Plugin Descriptions](#MavenReqPluginsDescriptions)
    1. [Plugin Configurations](#MavenReqPluginsConfigurations)


## Introduction <a name="introduction"></a>
Deploying to Maven Central is currently an automated process, but the steps are a bit of a black box that deserves some level of explanation in the event there is a need to update it or change it and the original author is no longer around.

## Prerequisites <a name="Prerequisites"></a>
There are a couple things you will need to do before attempting to deploy to Maven Central.
1.	You will need an account on Maven Central: https://central.sonatype.com/
    1. You will also need to be added to the `gov.hhs.aspr.ms group`. To be added to the group, a current member of the group (currently Zach Bischoff, Shawn Hatch and David Durham) must send an email to central-support@sonatype.com requesting your account be added to the gov.hhs.aspr.ms group.
    2.	You will need to generate a user token: https://central.sonatype.org/publish/generate-portal-token/
    3.	You will need your maven central username. **NOTE** that this is *NOT* the username you sign in with. It is different. It will be displayed when you generate a token in the previous step
2.	You need a signed pgp key. Instructions can be found here: https://central.sonatype.org/publish/requirements/gpg 


## GitHub Configuration <a name="GitHubConfiguration"></a>
### GitHub Actions Secrets <a name="GitHubActionSecrets"></a>
#### List of Secrets <a name="GitHubActionSecretsList"></a>
Each repository that we control has the following Secrets Defined under Settings -> Security -> Secrets and Variables -> Actions:

1.	GHA_BOT
2.	GPG_SECRET_KEY
3.	GPG_SECRET_KEY_PASSWORD
4.	MAVEN_CENTRAL_TOKEN
5.	MAVEN_CENTRAL_USERNAME
#### Purpose of Each Secret <a name="GitHubActionSecretsPurpose"></a>
Each secret serves a purpose for enabling the auto deployment to Maven Central when a new version is pushed to the main branch.
1.	GHA_BOT
    - This is a Personal access token (Currently generated under Zach Bischoffâ€™s github account) that allows an upstream GitHub Action workflow to commit and push to a downstream GitHub Repo. (ie Allows ASPR-8 GitHub Action to commit and push to aspr-ms-gcm-taskit repo)
2.	GPG_SECRET_KEY
    - From the prerequisites step 2, this is the secret key that you made. (Currently this is a key that Zachary Bischoff made, and it expires in 2027). This serves as the key to sign the artifacts from the maven build prior to uploading them to Maven Central. The signing of the artifacts is REQUIRED.
3.	GPG_SECRET_KEY_PASSWORD
    - Same as above, but the signing key requires a password, and that is the value of this field. The current password is known by Zachary Bischoff. The password is unique to the specific secret key but can be the same over various keys.
4.	MAVEN_CENTRAL_TOKEN
    - The user token from prerequisites step 1b. Currently this is generated by Zachary Bischoff. This serves as the password for authenticating to Maven Central for purposes of publishing.
5.	MAVEN_CENTRAL_USERNAME
    - The username from prerequisites step 1c. Currently this is generated by Zachary Bischoff. This serves as the username for authenticating to Maven Central for purposes of publishing.


### GitHub Actions Workflow <a name="GitHubActionsWorkflow"></a>
When pushing a new version to the main branch, a Github action workflow runs. This action is defined in the `.github/workflows/release_build.yml` file in the repo.
#### Workflow Description <a name="GitHubActionsWorkflowDescription"></a>
The workflow does the following, in the following order:
1. Checkout the repo on the main branch
2. Setup up Java and Maven
    - This includes setting the MAVEN_CENTRAL_TOKEN, MAVEN_CENTRAL_USERNAME, GPG_SECRET_KEY and GPG_SECRET_KEY_PASSWORD
3. run the command `mvn deploy -Pjavadoc,sign --file pom.xml`
    - deploy will trigger the deployment to Maven Central
    - -Pjavadoc will generate javadocs, this is required for Maven Central Deployment
    - -Psign will sign all of the generated files, this is required for Maven Central Deployment
    - --file just signifies which pom file to run the maven command against, in this case, the pom.xml in the root directory of the repo
4. Get the version of the software and save it to an enviroment variable by running the command `echo "version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout --file pom.xml)" >> "$GITHUB_ENV"`
5. Create a Github Release using the version from step 4 and the files generated by step 3.

## Maven Pom File Configuration <a name="MavenConfig"></a>
### Required Plugins <a name="MavenReqPlugins"></a>
To Deploy to Maven Central, you need the Plugins defined in the publish requirements on https://central.sonatype.org/publish/requirements. At a minimum you need the `maven-gpg-plugin`, `maven-javadoc-plugin`, `maven-source-plugin` and `central-publishing-maven-plugin`. The `flatten-maven-plugin` is helpful but not required.
### Plugin Descriptions <a name="MavenReqPluginsDescriptions"></a>
- `flatten-maven-plugin` creates a flattened version of the pom file, with all dependencies including transitive dependencies 
- `maven-source-plugin` creates the sources jar file
- `maven-javadoc-plugin` creates the javadoc jar file
- `maven-gpg-plugin` signs all created files, jar, source jar, javadoc jar, and pom file
### Plugin Configurations <a name="MavenReqPluginsConfigurations"></a>
- `flatten-maven-plugin` use the `<flattenMode>ossrh</flattenMode>` to create a pom file adequate for deployment to Maven Central
- `maven-source-plugin` use the goal `jar-no-fork`
- `maven-javadoc-plugin` use `<doclint>all,-missing</doclint>`, add any additional dependencies and add the following:
    ```
    <additionalJOptions>
        <additionalJOption>-Xmaxerrs</additionalJOption>
        <additionalJOption>65536</additionalJOption>
        <additionalJOption>-Xmaxwarns</additionalJOption>
        <additionalJOption>65536</additionalJOption>
    </additionalJOptions>
    ```
    To esnure that as many errors and warnings are found as possible in a single execution

